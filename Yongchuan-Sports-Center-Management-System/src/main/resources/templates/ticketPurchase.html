<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <script src="../static/js/jquery-3.3.1.min.js"></script>
    <link href="../static/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <script src="../static/js/bootstrap.min.js"></script>
    <link href="../static/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="../static/css/ticket.css" rel="stylesheet" type="text/css">
   <!-- <script src="webjars/jquery/1.12.1/jquery.min.js"></script>
    <link href="webjars/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <script src="webjars/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <link href="../static/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="../static/css/ticket.css" rel="stylesheet" type="text/css">-->
    <title>购票系统</title>
</head>
<body>
<div data-role="page" style="overflow-x: hidden;/* background: #eaeaea;*/">
    <div class="container" data-role="content">
        <div class="row">
            <div class="col-md-10 col-md-offset-1" style="text-align:center">
                <!--选项卡-->
                <div th:if="1<0">123</div>
                <div class="search">
                    <dl class="Categories">
                        <dt class="left">分&ensp;类：</dt>
                        <dd class="all"><a th:href="@{/ticketPurchase(type='',subtype='')}" th:class="${type==''?'this':''}" >全部</a></dd>
                        <dd class="right" style="float: left;width: 75%;">
                            <ul style="padding: 0;" >
                                <li><a th:href="@{/ticketPurchase(type='Music',subtype='')}" th:class="${type=='Music'?'this':''}" value="Music">音乐会</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Theatre',subtype='')}" th:class="${type=='Theatre'?'this':''}" value="Theatre">戏剧</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Concert',subtype='')}" th:class="${type=='Concert'?'this':''}" value="Concert">演唱会</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Dance',subtype='')}" th:class="${type=='Dance'?'this':''}" value="Dance">舞蹈</a></li>
                                <li><a th:href="@{/ticketPurchase(type='TraditionalOpera',subtype='')}" th:class="${type=='TraditionalOpera'?'this':''}" value="TraditionalOpera">戏曲</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Sports',subtype='')}" th:class="${type=='Sports'?'this':''}" value="Sports">体育</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Acrobatics',subtype='')}" th:class="${type=='Acrobatics'?'this':''}" value="Acrobatics">杂技</a></li>
                            </ul>
                        </dd>
                    </dl>
                    <dl class="Small_class" th:if="${type!=''}">
                        <dt class="left">子&ensp;类：</dt>
                        <dd class="right">
                            <ul style="padding: 0;" th:if="${type=='Music'}">
                                <li><a th:href="@{/ticketPurchase(type='Music',subtype='Chorus')}" class="" value='Chorus'>声乐及合唱</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Music',subtype='AncientMusic')}" class="" value='AncientMusic'>室内乐及古乐</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Music',subtype='Solo')}" class="" value='Solo'>独奏</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Music',subtype='Other')}" class="" value='Other'>其他</a></li>
                            </ul>
                        </dd>
                        <dd class="right" th:if="${type=='Theatre'}">
                            <ul style="padding: 0;">
                                <li><a th:href="@{/ticketPurchase(type='Theatre',subtype='Drama')}" class="" value='Drama'>话剧</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Theatre',subtype='Opera')}" class="" value='Opera'>歌剧</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Theatre',subtype='TheLivingTheatre')}" class="" value='TheLivingTheatre'>舞台剧</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Theatre',subtype='Other')}" class="" value='Other'>其他</a></li>
                            </ul>
                        </dd>
                        <dd class="right" style="" th:if="${type=='Concert'}">
                            <ul style="padding: 0;">
                                <li><a th:href="@{/ticketPurchase(type='Concert',subtype='Rock')}" class="" value='Rock'>摇滚</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Concert',subtype='Nation')}" class="" value='Nation'>民族</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Concert',subtype='Popular')}" class="" value='Popular'>流行</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Concert',subtype='Festival')}" class="" value='Festival'>音乐节</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Concert',subtype='Sir')}" class="" value='Sir'>爵士</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Concert',subtype='Other')}" class="" value='Other'>其他</a></li>
                            </ul>
                        </dd>
                        <dd class="right" style="" th:if="${type=='Dance'}">
                            <ul style="padding: 0;">
                                <li><a th:href="@{/ticketPurchase(type='Dance',subtype='LatinDance')}" class="" value='LatinDance'>拉丁舞</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Dance',subtype='ModernDance')}" class="" value='ModernDance'>现代舞</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Dance',subtype='FolkDance')}" class="" value='FolkDance'>民族舞</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Dance',subtype='Ballet')}" class="" value='Ballet'>芭蕾舞</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Dance',subtype='Jazz')}" class="" value='Jazz'>爵士舞</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Dance',subtype='ModernDancing')}" class="" value='ModernDancing'>摩登舞</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Dance',subtype='Other')}" class="" value='Other'>其他</a></li>
                            </ul>
                        </dd>
                        <dd class="right" style="" th:if="${type=='TraditionalOpera'}">
                            <ul style="padding: 0;">
                                <li><a th:href="@{/ticketPurchase(type='TraditionalOpera',subtype='BeijingOpera')}" class="" value='BeijingOpera'>京剧</a></li>
                                <li><a th:href="@{/ticketPurchase(type='TraditionalOpera',subtype='ShaoxingOpera')}" class="" value='ShaoxingOpera'>越剧</a></li>
                                <li><a th:href="@{/ticketPurchase(type='TraditionalOpera',subtype='Huangmeixi')}" class="" value='Huangmeixi'>黄梅戏</a></li>
                                <li><a th:href="@{/ticketPurchase(type='TraditionalOpera',subtype='PingJuOpera')}" class="" value='PingJuOpera'>评剧</a></li>
                                <li><a th:href="@{/ticketPurchase(type='TraditionalOpera',subtype='HenanOpera')}" class="" value='HenanOpera'>豫剧</a></li>
                                <li><a th:href="@{/ticketPurchase(type='TraditionalOpera',subtype='Other')}" class="" value='Other'>其他</a></li>
                            </ul>
                        </dd>
                        <dd class="right" style="" th:if="${type=='Sports'}">
                            <ul style="padding: 0;">
                                <li><a th:href="@{/ticketPurchase(type='Sports',subtype='Football')}" class="" value='Football'>足球</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Sports',subtype='Basketball')}" class="" value='Basketball'>篮球</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Sports',subtype='TableTennis')}" class="" value='TableTennis'>乒乓球</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Sports',subtype='Swimming')}" class="" value='Swimming'>游泳</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Sports',subtype='Bodybuilding')}" class="" value='Bodybuilding'>健身</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Sports',subtype='Badminton')}" class="" value='Badminton'>羽毛球</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Sports',subtype='Athletics')}" class="" value='Athletics'>田径</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Sports',subtype='Tennis')}" class="" value='Tennis'>网球</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Sports',subtype='Shotput')}" class="" value='Shotput'>铅球</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Sports',subtype='Other')}" class="" value='Other'>其他</a></li>
                            </ul>
                        </dd>
                        <dd class="right" style="" th:if="${type=='Acrobatics'}">
                            <ul style="padding: 0;">
                                <li><a th:href="@{/ticketPurchase(type='Acrobatics',subtype='Acrobatics')}" class="" value='Acrobatics'>器械杂技</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Acrobatics',subtype='BodyAcrobatics')}" class="" value='BodyAcrobatics'>形体杂技</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Acrobatics',subtype='AerialAcrobatics')}" class="" value='AerialAcrobatics'>高空杂技</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Acrobatics',subtype='OralSkills')}" class="" value='OralSkills'>口技</a></li>
                                <li><a th:href="@{/ticketPurchase(type='Acrobatics',subtype='Other')}" class="" value='Other'>其他</a></li>
                            </ul>
                        </dd>
                    </dl>
                </div>
                <!--票据信息-->
                <div class="ticket">
                    <ul>
                        <li th:each="ticket,ticketNumber : ${Tickets}">

                            <div class="search_img">
                                <img alt="" th:src="${ticket.poster}">
                                <div class="info">
                                    <h3>【<span th:text="${ticket.address}"></span>】<a href="#" target="_blank" th:text="${ticket.title}"></a></h3>
                                    <p class="txt_time">
                                        <a href="#"><span class="fa fa-calendar" th:text="${#dates.format(ticket.showTimeStart,'yyyy/MM/dd HH:MM')}"></span></a>
                                    </p>
                                    <p class="txt_add">
                                        <a href="#"><span class="fa fa-map-marker " th:text="${ticket.detailedAddress}+'-'+${ticket.address}"></span></a>
                                    </p>
                                    <p class="txt_piao">
                                        <em th:text="${ticket.price}"></em>
                                        <span class="badge green" th:text="已售完" th:if="${ticket.state=='ending'}"></span>
                                        <span class="badge green" th:text="售票中" th:if="${ticket.state=='Ticketing'}"></span>
                                        <span class="badge green" th:text="待售" th:if="${ticket.state=='Waiting'}"></span>
                                    </p>
                                </div>
                                <div class="gp_btn">
                                    <span th:text="${ticket.id}" style="display: none"></span>
                                    <button class="btn btn-primary BuyTicket" style="float: right;"  data-toggle="modal" data-target="#empUpdateModal1">购票</button>
                                    <div class="check_num">
                                        <a class="reduce" th:onclick="'javascript:setAmount.reduce(&quot;#qty_item_'+${ticketNumber.index}+'&quot;)'" href="javascript:void(0)"> - </a>
                                        <input type="text" th:name="'qty_item_'+${ticketNumber.index}" value="1" th:id="'qty_item_'+${ticketNumber.index}" th:onkeyup="'javascript:setAmount.modify(&quot;#qty_item_'+${ticketNumber.index}+'&quot;)'" class="text"/>
                                        <a class="add" th:onclick="'javascript:setAmount.add(&quot;#qty_item_'+${ticketNumber.index}+'&quot;)'" href="javascript:void(0)"> + </a>
                                    </div>
                                </div>
                            </div>
                        </li>
                    </ul>
                    <!--购票模态框-->
                    <div class="modal fade" id="empUpdateModal1" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                    <h4 class="modal-title">购票信息</h4>
                                </div>
                                <div class="modal-body" style="height: 250px;">
                                    <form>
                                        <img alt="" src="" id="ticketImg">
                                        <input type="hidden" name="commodityId" id="commodityId" />
                                        <input type="hidden" name="payer" th:value="${session.user.username}"/>
                                        <div class="info">
                                            <h3>【<span id="address"></span>】<a href="#" target="" name="commodityName1" id="commodityName1"></a></h3>
                                            <p class="txt_time">
                                                <a href="#"><span class="fa fa-calendar" id="startTime"></span></a>
                                            </p>
                                            <p class="txt_add">
                                                <a href="#"><span class="fa fa-map-marker " id="detailedAddress"></span></a>
                                            </p>
                                            <p class="num">
                                                <a class="chose">
                                                    <!--<img src="../static/img/1.png">-->
                                                    选区：
                                                    <select name="partition" id="partition">
                                                        <option value="A" selected = "selected">A</option>
                                                        <option value="B">B</option>
                                                        <option value="C">C</option>
                                                        <option value="D">D</option>
                                                        <option value="E">E</option>
                                                        <option value="F">F</option>
                                                    </select>
                                                </a>&emsp;
                                                <span id="aArea" style="display: none"></span>
                                                <span id="bArea" style="display: none"></span>
                                                <span id="cArea" style="display: none"></span>
                                                <span id="dArea" style="display: none"></span>
                                                <span id="eArea" style="display: none"></span>
                                                <span id="fArea" style="display: none"></span>
                                                <span>单价：<em><a name="univalence1" id="univalence1"></a></em>元</span>&emsp;
                                                <span>数量：<em><a id="number1" name="number1"></a></em>张</span>
                                            </p>
                                        </div>
                                        <h3 class="zongjia">共计：<em><a id="totalPrice1" name="totalPrice"></a></em>元</h3>
                                        <input name="totalPrice" id="totalPrice" type="hidden">
                                        <input name="univalence" id="univalence" type="hidden">
                                        <input name="commodityName" id="commodityName" type="hidden">
                                        <input name="state" type="hidden" value="paid">
                                        <input name="number" id="number" type="hidden">
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="submit" class="btn btn-primary" id="pay">付款</button>
                                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--分页-->
                    <footer class="site-footer">
                        <div>
                            <div style="text-align: center">
                                显示
                                <span class="num1" th:if="${page.size}>=10">10</span>
                                <span class="num1" th:if="${page.size}<10" th:text="${page.size}"></span>
                                条记录，共<span class="num1" th:text="${page.total}"></span>条记录
                            </div>
                            <div style="text-align: center;">
                                <ul class="pagination">
                                    <li><a th:href="@{/ticketPurchase(type=${type},subtype=${subtype},PageNum=1)}">首页</a></li>
                                    <li><a th:href="@{/ticketPurchase(type=${type},subtype=${subtype},PageNum=${page.prePage})}" th:onclick="Jump(${page.prePage})" th:if="${page.isFirstPage}==false">&lt;上一页</a></li>
                                    <li th:each="navigatepageNum : ${page.navigatepageNums}">
                                        <a th:value="${navigatepageNum}" th:text="${navigatepageNum}" th:href="@{/ticketPurchase(type=${type},subtype=${subtype},PageNum=${navigatepageNum})}"></a>
                                    </li>
                                    <li><a th:href="@{/ticketPurchase(type=${type},subtype=${subtype},PageNum=${page.nextPage})}" th:if="${page.isLastPage}==false">下一页&gt;</a></li>
                                    <li><a th:href="@{/ticketPurchase(type=${type},subtype=${subtype},PageNum=${page.pages})}">末页</a></li>
                                </ul>
                            </div>
                            <!-- <span><input type="text" class="ipt" value="" id="_page_input_num" #if($pages == 0)disabled#end/></span>
                              <span><input type="button" value="跳转" class="sure" id="Jump"  #if($pages == 0)disabled#end/></span>-->
                        </div>
                    </footer>
                </div>
            </div>
        </div>
    </div>
    <div data-role="footer">

    </div>
</div>

<script>
    //  数量增减（1~4张）
    var setAmount = {
        min:1,
        max:4,
        reg:function(x) {
            return new RegExp("^[1-9]\\d*$").test(x);
        },
        amount:function(obj, mode) {
            var x = $(obj).val();
            if (this.reg(x)) {
                if (mode) {
                    x++;
                } else {
                    x--;
                }
            } else {
                alert("请输入正确的数量！");
                $(obj).val(1);
                $(obj).focus();
            }
            return x;
        },
        reduce:function(obj) {
            var x = this.amount(obj, false);
            if (x >= this.min) {
                $(obj).val(x);
                // recalc();
            } else {
                alert("商品数量最少为" + this.min);
                $(obj).val(1);
                $(obj).focus();
            }
        },
        add:function(obj) {
            var x = this.amount(obj, true);
            if (x <= this.max) {
                $(obj).val(x);
                recalc();
            } else {
                alert("商品数量最多为" + this.max);
                $(obj).val(4);
                $(obj).focus();
            }
        },
        modify:function(obj) {
            var x = $(obj).val();
            if (x < this.min || x > this.max || !this.reg(x)) {
                alert("请输入正确的数量！");
                $(obj).val(1);
                $(obj).focus();
            }
        }
    };

    // modal 模态框
    $("#empUpdateModal").modal({
        backdrop:"static"
    });
    //获取票价信息
    $(".BuyTicket").click(function () {
        var id=$(this).parent().find("span").text();
        var number = $(this).parent().find("input").val();
       $.ajax({
           url:"/ticket/"+id,
           type:"GET",
           success:function (result) {
               console.log(result);
             $("#commodityId").val(result.id);
             $("#commodityName1").text(result.title);
            $("#aArea").text(result.aArea);
            $("#bArea").text(result.bArea);
            $("#cArea").text(result.cArea);
            $("#dArea").text(result.dArea);
            $("#eArea").text(result.eArea);
            $("#fArea").text(result.fArea);
            $("#startTime").text(result.showTimeStart);
            $("#number1").text(number);
            $("#address").text(result.address);
            $("#ticketImg").attr("src",result.poster);
            $("#detailedAddress").text(result.address+"-"+result.detailedAddress);
               var x=$("#partition").val();
               if (x=="A"){
                   $("#univalence1").text($("#aArea").text());
               }else if (x=="B"){
                   $("#univalence1").text($("#bArea").text());
               }else if (x=="C"){
                   $("#univalence1").text($("#cArea").text());
               }else if (x=="D"){
                   $("#univalence1").text($("#dArea").text());
               }else if (x=="E"){
                   $("#univalence1").text($("#eArea").text());
               }else if (x=="F"){
                   $("#univalence1").text($("#fArea").text());
               }
               //计算总价
               $("#totalPrice1").text(number*$("#univalence1").text());
           }
       });
    });
    //根据不同分区更改价格
    $("#partition").change(function () {
        var x = $(this).val();
        if (x=="A"){
            $("#univalence1").text($("#aArea").text());
        }else if (x=="B"){
            $("#univalence1").text($("#bArea").text());
        }else if (x=="C"){
            $("#univalence1").text($("#cArea").text());
        }else if (x=="D"){
            $("#univalence1").text($("#dArea").text());
        }else if (x=="E"){
            $("#univalence1").text($("#eArea").text());
        }else if (x=="F"){
            $("#univalence1").text($("#fArea").text());
        }
        $("#totalPrice1").text($("#number1").text()*$("#univalence1").text());
    });
    //点击购票，发起购票请求
    $("#pay").click(function () {
        //将值填充到input中
        $("#commodityName").val($("#commodityName1").text());
        $("#number").val($("#number1").text());
        $("#univalence").val($("#univalence1").text());
        $("#totalPrice").val($("#totalPrice1").text());
       $.ajax({
           url:"/ticketPurchase",
           type:"POST",
           data:$("#empUpdateModal1 form").serialize(),
           success:function (result) {
               alert(result);
           }
       })
    });

</script>
</body>
</html>